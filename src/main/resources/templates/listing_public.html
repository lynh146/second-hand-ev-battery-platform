<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${listing != null ? listing.title + ' - EV MARKET' : 'Tin không tồn tại'}"></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/listing_public.css">
</head>

<body>

<div th:replace="fragments/header :: header"></div>

<section class="container py-4 listing-detail-page">

    <!-- ❗ Tin không tồn tại -->
    <div th:if="${notFound}" class="alert alert-warning text-center fs-5 my-5">
        Tin đăng không tồn tại hoặc đã bị xóa.
    </div>

    <!-- Tin null → stop -->
    <div th:if="${notFound == true}" th:remove="tag"></div>


    <!-- ===================================== -->
    <!-- UI CHÍNH -->
    <!-- ===================================== -->
    <div class="row g-4" th:if="${listing != null}">

        <!-- LEFT -->
        <div class="col-lg-8">

            <div class="detail-main-card p-3 rounded-4 bg-white shadow-sm">

                <!-- BIG IMAGE -->
                <div class="image-wrapper position-relative mb-3">
                    <img id="bigImage"
                         class="main-photo"
                         th:src="${listing.images.size() > 0 ? listing.images.get(0).imageUrl : '/images/no-image.png'}">

                    <button class="btn-nav prev" id="btnPrev"><i class="fa-solid fa-chevron-left"></i></button>
                    <button class="btn-nav next" id="btnNext"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <!-- THUMB -->
                <div class="thumb-list d-flex flex-wrap gap-2">
                    <img th:each="img,iter : ${listing.images}"
                         th:src="${img.imageUrl}"
                         class="thumb"
                         th:classappend="${iter.index == 0} ? ' active'"
                         th:attr="data-index=${iter.index}">
                </div>

                <!-- DESCRIPTION -->
                <div class="mt-4">
                    <h5 class="fw-bold">Mô tả chi tiết</h5>
                    <p th:text="${listing.description}"></p>
                </div>

                <!-- SPEC -->
                <div class="mt-4">
                    <h5 class="fw-bold">Thông số kỹ thuật</h5>

                    <table class="table table-sm spec-table" th:if="${listing.vehicle != null}">
                        <tbody>
                        <tr><th>Hãng xe</th><td th:text="${listing.vehicle.brand}"></td></tr>
                        <tr><th>Model</th><td th:text="${listing.vehicle.model}"></td></tr>
                        <tr><th>Loại xe</th><td th:text="${listing.vehicle.type}"></td></tr>
                        <tr><th>Năm sản xuất</th><td th:text="${listing.vehicle.manufactureYear}"></td></tr>
                        <tr><th>Số km đã đi</th><td th:text="${listing.vehicle.mileage + ' km'}"></td></tr>
                        <tr><th>Dung lượng pin</th><td th:text="${listing.vehicle.capacity}"></td></tr>
                        </tbody>
                    </table>

                    <table class="table table-sm spec-table" th:if="${listing.battery != null}">
                        <tbody>
                        <tr><th>Hãng pin</th><td th:text="${listing.battery.brand}"></td></tr>
                        <tr><th>Dung lượng</th><td th:text="${listing.battery.capacityKWh + ' kWh'}"></td></tr>
                        <tr><th>Tình trạng</th><td th:text="${listing.battery.batteryCondition}"></td></tr>
                        </tbody>
                    </table>
                </div>

            </div>

        </div>

        <!-- RIGHT -->
        <div class="col-lg-4">

            <div class="seller-card bg-white rounded-4 shadow-sm p-3 mb-3">

                <!-- TITLE -->
                <h3 class="fw-bold mb-2" th:text="${listing.title}"></h3>

                <!-- PRICE -->
                <p class="price fs-3 fw-bold text-danger"
                   th:text="${#numbers.formatInteger(listing.price,3,'POINT')} + ' đ'"></p>

                <!-- SOLD BADGE -->
                <div th:if="${listing.status == 'SOLD'}"
                     class="alert alert-danger text-center fw-bold">
                    ĐÃ BÁN
                </div>


                <!-- ======================== -->
                <!-- OWNER (CHỈNH SỬA / XÓA) -->
                <!-- ======================== -->
                <div th:if="${#authentication != null 
                             and #authentication.name == listing.user.email
                             and listing.status != 'SOLD'}">

                    <button class="btn btn-outline-primary w-100 mb-2"
                            th:onclick="'window.location.href=\'/member/listings/edit/' + ${listing.listingID} + '\';'">
                        Chỉnh sửa tin
                    </button>

                    <button class="btn btn-outline-danger w-100"
                            th:onclick="'if(confirm(\'Xóa tin này?\')) window.location.href=\'/member/listings/delete/' + ${listing.listingID} + '\';'">
                        Xóa tin
                    </button>
                </div>


                <!-- ======================================================== -->
                <!-- USER KHÁC – HÀNH ĐỘNG (ẨN KHI SOLD hoặc chủ tin) -->
                <!-- ======================================================== -->
                <div th:if="${listing.status != 'SOLD'
                            and (#authorization.expression('isAnonymous()') 
                                 or #authentication.name != listing.user.email)}">

                    <button id="btnBuyNow"
                            class="btn btn-dark w-100 mb-2"
                            th:attr="data-listing-id=${listing.listingID},
                                     data-authenticated=${#authorization.expression('isAuthenticated()')}">
                        Mua ngay
                    </button>
<!-- SO SÁNH -->
<form action="/compare/add" method="post" class="w-100 mb-2">
    <input type="hidden" name="listingId" th:value="${listing.listingID}">
    <button class="btn btn-outline-secondary w-100">
        So sánh
    </button>
</form>


<!-- lưu tin -->
<form th:action="@{'/member/favorites/toggle/' + ${listing.listingID}}" method="post">
    <button class="btn w-100"
            th:classappend="${saved} == true ? 'btn-danger text-white' : 'btn-outline-danger'">
        <i class="fa-regular fa-heart me-2"></i>
        <span th:text="${saved} == true ? 'Đã lưu' : 'Lưu tin'"></span>
    </button>
</form>


                </div>

            </div>

        </div>

    </div>

</section>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/header.js}"></script>
<script th:src="@{/js/listing_public.js}"></script>

</body>
</html>
